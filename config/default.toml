# Harbor Cache Configuration

[server]
bind_address = "0.0.0.0"
port = 5001

[cache]
# Maximum cache size in bytes (10 GB)
max_size = 10737418240
# Number of days to retain cached artifacts
retention_days = 30
# Eviction policy: "lru", "lfu", or "fifo"
eviction_policy = "lru"

# ============================================================================
# UPSTREAM CONFIGURATION
# ============================================================================
# You can configure upstreams in several ways:
#
# 1. Legacy single [upstream] format (for backwards compatibility):
#    [upstream]
#    url = "http://localhost:8880"
#    registry = "library"
#    username = "admin"
#    password = "Harbor12345"
#
# 2. New multi-upstream [[upstreams]] format (recommended):
#    Supports multiple upstreams with route-based selection.
#
# 3. Multi-project mode (NEW):
#    Access multiple projects from the same Harbor instance without
#    duplicating connection settings. Use the [[upstreams.projects]] array
#    instead of a single "registry" field.
#
# If both [upstream] and [[upstreams]] are present, [[upstreams]] takes precedence.
# Legacy [upstream] is automatically migrated to [[upstreams]] at startup.
# ============================================================================

# Default upstream configuration (single-project mode)
[[upstreams]]
name = "default"
display_name = "Default Upstream"
url = "http://localhost:8880"
registry = "library"
username = "admin"
password = "Harbor12345"
skip_tls_verify = true
priority = 100
enabled = true
cache_isolation = "shared"  # "shared" or "isolated"
is_default = true

# Optional: Add route patterns for this upstream
# Routes allow you to direct requests to specific upstreams based on repository path
# [[upstreams.routes]]
# pattern = "library/*"
# priority = 100

# ============================================================================
# MULTI-PROJECT MODE EXAMPLE
# ============================================================================
# Instead of creating separate upstreams for each project on the same Harbor
# instance, you can use multi-project mode. This reduces configuration
# duplication and allows you to manage credentials in one place.
#
# When [[upstreams.projects]] is configured, the "registry" field becomes a
# fallback for unmatched requests.
# ============================================================================

# Example: Multi-project upstream for accessing multiple projects
# [[upstreams]]
# name = "main-harbor"
# display_name = "Main Harbor Registry"
# url = "https://harbor.example.com"
# registry = "library"  # Fallback for unmatched requests
# username = "admin"
# password = "secret"
# skip_tls_verify = false
# priority = 100
# enabled = true
# cache_isolation = "shared"
# is_default = true
#
# # Project: library (default)
# [[upstreams.projects]]
# name = "library"
# pattern = "library/*"  # Optional: defaults to "{name}/*"
# priority = 100
# is_default = true
#
# # Project: team-a
# [[upstreams.projects]]
# name = "team-a"
# pattern = "team-a/*"
# priority = 50
#
# # Project: team-b
# [[upstreams.projects]]
# name = "team-b"
# pattern = "team-b/*"
# priority = 50

# Example: Add another upstream for team-specific images (single-project mode)
# [[upstreams]]
# name = "team-a"
# display_name = "Team A Registry"
# url = "https://harbor2.example.com"
# registry = "team-a"
# username = "team-a-user"
# password = "team-a-secret"
# skip_tls_verify = false
# priority = 50
# enabled = true
# cache_isolation = "isolated"
# is_default = false
#
# [[upstreams.routes]]
# pattern = "team-a/*"
# priority = 50

[storage]
# Storage backend: "local" or "s3"
backend = "local"

[storage.local]
# Path for local cache storage
path = "./data/cache"

[storage.s3]
# S3 configuration (used when backend = "s3")
# bucket = "harbor-cache"
# region = "us-east-1"
# endpoint = "http://localhost:9000"  # For MinIO or other S3-compatible services
# access_key = ""
# secret_key = ""
# prefix = ""  # Optional prefix for all objects
# allow_http = false  # Allow HTTP (not HTTPS) for MinIO local dev

[database]
# SQLite database path
path = "./data/harbor-cache.db"

[auth]
# JWT secret for token signing (change in production!)
jwt_secret = "change-me-in-production"
# Enable authentication
enabled = true

[logging]
# Log level: "trace", "debug", "info", "warn", "error"
level = "info"
# Log format: "pretty" or "json"
format = "pretty"

[tls]
# Enable TLS/HTTPS
enabled = false
# Path to TLS certificate file (PEM format)
# cert_path = "/path/to/cert.pem"
# Path to TLS private key file (PEM format)
# key_path = "/path/to/key.pem"
